#!/usr/bin/env node

/**
 * @file chatloop.js
 * @description
 *   ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ô‡∏µ‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á Command-Line Interface (CLI) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö AI ‡πÅ‡∏ö‡∏ö‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö
 *   ‡∏ñ‡∏π‡∏Å‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏õ‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ô system command ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ç‡∏≠‡∏á AI ‡πÑ‡∏î‡πâ
 *   ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ö‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡∏°‡∏¥‡∏ô‡∏±‡∏•‡∏ó‡∏µ‡πà‡∏ó‡∏£‡∏á‡∏û‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
 *
 * @features
 *   - Interactive Chat Loop: ‡∏ß‡∏ô‡∏£‡∏±‡∏ö-‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
 *   - AI Integration: ‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Å‡∏±‡∏ö AI service ‡∏ú‡πà‡∏≤‡∏ô HTTP API
 *   - System Command Execution: AI ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô shell command ‡πÑ‡∏î‡πâ (‡πÄ‡∏ä‡πà‡∏ô `ls -la`, `cat file.txt`)
 *     ‡πÇ‡∏î‡∏¢‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏à‡∏∞‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠, ‡∏ñ‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢, ‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á,
 *     ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏´‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡πà‡∏≠
 *   - Natural Language Confirmation: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ (‡πÄ‡∏ä‡πà‡∏ô "yes", "ok", "‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢")
 *   - Asynchronous Operations: ‡πÉ‡∏ä‡πâ async/await ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ I/O ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î‡∏Å‡∏±‡πâ‡∏ô ‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö input, ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API, ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
 *   - User-Friendly Feedback: ‡πÉ‡∏ä‡πâ loading spinner (`ora`) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤ AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
 *   - Slash Commands: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏ä‡πà‡∏ô `/help`, `/clear`, ‡πÅ‡∏•‡∏∞ `/exit`
 *   - Debug Mode: ‡∏°‡∏µ‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏µ‡∏ö‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô environment variable ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π log ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
 *
 * @how_it_works
 *   1. Initialization: ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≤‡∏á ‡πÜ (API host, port, auth) ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå `.env`
 *   2. Main Loop: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô `while` loop ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏£‡∏±‡∏ö input ‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ú‡πà‡∏≤‡∏ô `readline`
 *   3. AI Request: input ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô prompt ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö AI service
 *   4. Response Parsing: ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡∏≠‡∏á AI
 *      - ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏Å `[CMD]...[/CMD]`:
 *          a. ‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏°‡∏≤
 *          b. ‡∏ñ‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏±‡∏ô
 *          c. ‡∏´‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï ‡∏à‡∏∞‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô `child_process.exec`
 *          d. ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (stdout/stderr) ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡πÑ‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô prompt ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏´‡πâ AI
 *             ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÑ‡∏î‡πâ
 *      - ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
 *   5. State Management: `readline` ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏±‡πà‡∏á `pause` ‡πÅ‡∏•‡∏∞ `resume` ‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
 *      ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ input ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏≠‡∏á spinner ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏î‡πâ
 *   6. Error Handling: ‡∏°‡∏µ `try...catch` ‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
 */

require('dotenv').config();
const readline = require('readline');
const { exec } = require('child_process');
const http = require('http');
const https = require('https');
const ora = require('ora').default;

// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏´‡∏°‡∏î Debug ‡∏à‡∏≤‡∏Å Environment Variable
const IS_DEBUG_MODE = process.env.DEBUG_MODE === 'true' || process.env.DEBUG_MODE === '1';

// Helper function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Debug Log
const debugLog = (...args) => {
  if (IS_DEBUG_MODE) {
    console.log('[DEBUG]', ...args);
  }
};

// ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° readline
const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

// [DEBUG] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏î‡∏±‡∏Å‡∏ü‡∏±‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤ readline ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà
rl.on('close', () => {
  debugLog('Event "close" ‡∏ö‡∏ô readline ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
});

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á help
const showHelp = () => {
  console.log(`
üìö ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©:
  /clear_history_chat ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏ô‡∏ù‡∏±‡πà‡∏á AI
  /clear    ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
  /help     ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  /exit     ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°
  (‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏°‡∏µ /save, /theme, /log ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡πâ‡∏≤~)
`);
};

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á AI
async function sendToAI(prompt) {
  return new Promise((resolve, reject) => {
    const data = JSON.stringify({ prompt_msg: prompt });

    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ http ‡∏´‡∏£‡∏∑‡∏≠ https ‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô .env
    const useHttps = process.env.USE_HTTPS === 'true';
    const requester = useHttps ? https : http;
    debugLog(`Connecting to n8n via ${useHttps ? 'HTTPS' : 'HTTP'}`);

    const options = {
      hostname: process.env.AI_HOST,
      port: process.env.AI_PORT,
      path: process.env.AI_PATH,
      method: 'POST',
      auth: process.env.AI_AUTH,
      timeout: 240000, // 4 ‡∏ô‡∏≤‡∏ó‡∏µ
      headers: {
        'Content-Type': 'application/json',
        'Content-Length': Buffer.byteLength(data)
      }
    };

    const req = requester.request(options, (res) => {
      let body = '';

      res.on('data', (chunk) => {
        body += chunk;
      });

      res.on('end', () => {
        if (res.statusCode !== 200) {
          reject(new Error(`‚ùå HTTP ${res.statusCode}: ${res.statusMessage}\n${body}`));
          return;
        }
        try {
          const json = JSON.parse(body);
          resolve(json.output || '[‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å AI]');
        } catch (e) {
          reject(new Error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á JSON ‡πÑ‡∏î‡πâ:\n' + body));
        }
      });
    });

    req.on('timeout', () => {
      req.destroy();
      reject(new Error('‚ùå ‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ (4 ‡∏ô‡∏≤‡∏ó‡∏µ)'));
    });

    req.on('error', (error) => { // This handles network errors
      reject(new Error('‚ùå ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message));
    });

    req.write(data);
    req.end();
  });
}

// Helper function to ask a question and get an answer asynchronously.
function ask(question) {
  return new Promise(resolve => rl.question(question, resolve));
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ô system command
function executeSystemCommand(command) {
  debugLog(`Executing command: ${command}`);
  return new Promise((resolve) => {
    if (!command) {
      resolve("‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô");
      return;
    }
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î timeout ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏Ñ‡πâ‡∏≤‡∏á
    exec(command, { timeout: 60000 }, (error, stdout, stderr) => { // 1 ‡∏ô‡∏≤‡∏ó‡∏µ
      if (error) {
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î error ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà reject ‡πÅ‡∏ï‡πà‡∏à‡∏∞ resolve ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏î‡πâ
        const errorMessage = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≠‡∏ô‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: ${error.message}\n--- stderr ---\n${stderr}`;
        debugLog(errorMessage);
        resolve(errorMessage);
        return;
      }
      
      const result = `--- stdout ---\n${stdout}\n--- stderr ---\n${stderr}`;
      debugLog(`Command result:\n${result}`);
      resolve(result.trim());
    });
  });
}

// Helper function to check for affirmative responses in natural language
function isAffirmative(text) {
  const affirmativeWords = [
    // English
    'y', 'yes', 'ok', 'sure', 'yeah', 'yep', 'yup', 'go ahead', 'do it', 'please',
    // Thai
    '‡πÑ‡∏î‡πâ', '‡πÄ‡∏≠‡∏≤‡πÄ‡∏•‡∏¢', '‡∏à‡∏±‡∏î‡πÑ‡∏õ', '‡πÉ‡∏ä‡πà', '‡∏ï‡∏Å‡∏•‡∏á', '‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô', '‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏•‡∏¢', '‡∏ó‡∏≥‡πÄ‡∏•‡∏¢', '‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢'
  ];
  const lowerText = text.toLowerCase().trim();
  return affirmativeWords.includes(lowerText);
}

// üîÅ ‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢ ‡πÜ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏à‡∏ö
async function mainLoop() {
  console.log('ü§ñ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏à‡πâ‡∏≤~ ‡∏û‡∏¥‡∏°‡∏û‡πå /help ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢');

  while (true) {
    debugLog('>> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô while loop ‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà');
    const input = await ask('üë§: ');
    debugLog(`‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö input: "${input}"`);
    const text = input.trim();

    if (!text) {
      debugLog('input ‡∏ß‡πà‡∏≤‡∏á, ‡∏ß‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà');
      continue;
    }

    if (text === '/exit') {
      console.log('üëã ‡∏ö‡πä‡∏≤‡∏¢‡∏ö‡∏≤‡∏¢~ ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏ö‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞‡∏Ñ‡∏∞');
      rl.close();
      debugLog('‡∏™‡∏±‡πà‡∏á break ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å loop ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ /exit');
      break; // Exit the loop
    }

    if (text === '/help') {
      showHelp();
      debugLog('‡∏ß‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á /help');
      continue;
    }

    if (text === '/clear') {
      console.clear();
      console.log('ü§ñ ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÇ‡∏•‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏∏‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏•‡∏¢‡∏à‡πâ‡∏≤~');
      debugLog('‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏ß‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡∏°‡πà');
      continue;
    }

    if (text === '/clear_history_chat') {
      const spinner = ora('üóëÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ AI...');
      try {
        rl.pause();
        spinner.start();
        // ‡∏™‡πà‡∏á prompt ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á (n8n) ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        await sendToAI('/clear_history');
        spinner.succeed('‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏ù‡∏±‡πà‡∏á AI ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞');
      } catch (err) {
        spinner.fail(String(err.message || err));
        debugLog('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≠‡∏ô‡∏™‡πà‡∏á /clear_history');
      } finally {
        if (spinner.isSpinning) {
          spinner.stop();
        }
        rl.resume();
      }
      continue;
    }

    let currentPrompt = text;
    let isInteractionDone = false;
    const spinner = ora('ü§î ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î...');

    try {
      rl.pause(); // ‡∏´‡∏¢‡∏∏‡∏î readline ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≠ AI ‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
      spinner.start();

      while (!isInteractionDone) {
        debugLog(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å sendToAI ‡∏î‡πâ‡∏ß‡∏¢ prompt: "${currentPrompt}"`);
        spinner.text = 'ü§î AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î...';
        const reply = await sendToAI(currentPrompt);
        spinner.stop(); // ‡∏´‡∏¢‡∏∏‡∏î spinner ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
        debugLog(`AI ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ß‡πà‡∏≤: "${reply}"`);

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ AI ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏°‡∏≤‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö [CMD]...[/CMD] ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const commandMatch = reply.match(/\[CMD\]([\s\S]*?)\[\/CMD\]/);

        if (commandMatch) {
          const commandToExecute = commandMatch[1].trim();
          const aiMessage = reply.replace(commandMatch[0], '').trim();

          if (aiMessage) {
            console.log(`ü§ñ: ${aiMessage}`);
          }
          console.log(`\n‚ú® AI ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: ${commandToExecute}`);

          // ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
          // Resume readline ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏£‡∏±‡∏ö input
          rl.resume();
          const confirmation = await ask('üëâ ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏±‡πâ‡∏¢‡∏Ñ‡∏∞?: ');
          // Pause ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ spinner ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥
          rl.pause();

          if (!isAffirmative(confirmation)) {
            console.log('üö´ ‡πÇ‡∏≠‡πÄ‡∏Ñ‡∏Ñ‡πà‡∏≤ ‡∏á‡∏±‡πâ‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞');
            isInteractionDone = true;
            continue;
          }

          spinner.text = `‚öôÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô: ${commandToExecute}`;
          spinner.start();
          const commandResult = await executeSystemCommand(commandToExecute);
          spinner.succeed(`‚úÖ ‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á '${commandToExecute}' ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô`);

          console.log(`\n--- ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ---\n${commandResult}\n----------------------\n`);

          // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° prompt ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏´‡πâ AI
          currentPrompt = `The command "${commandToExecute}" was executed and this was the output:\n\n${commandResult}\n\nBased on this, please analyze the result and continue with the next step or provide the final answer to the user.`;
          spinner.start(); // ‡πÄ‡∏£‡∏¥‡πà‡∏° spinner ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠ AI ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö
        } else {
          // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏à‡∏≤‡∏Å AI
          console.log(`ü§ñ: ${reply}`);
          isInteractionDone = true;
        }
      }
    } catch (err) {
      spinner.fail(String(err.message || err));
      debugLog('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô interaction loop');
    } finally {
      if (spinner.isSpinning) {
        spinner.stop();
      }
      debugLog('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞ resume readline...');
      rl.resume();
    }
    debugLog('<< ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô while loop ‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ');
  }
  debugLog('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å while loop ‡πÅ‡∏•‡πâ‡∏ß');
}

mainLoop().catch(err => {
  console.error('\nüí• ‡πÇ‡∏≠‡πä‡∏∞! ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏Ñ‡∏¥‡∏î ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏á');
  console.error(err);
  process.exit(1);
});